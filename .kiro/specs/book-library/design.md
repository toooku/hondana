# 蔵書管理アプリケーション - デザイン文書

## 概要

蔵書管理アプリケーションは、Pythonで実装される個人用の本管理システムです。以下の主要コンポーネントで構成されます：

1. **データモデル層**: 本と感想のデータ構造
2. **API統合層**: OpenBD APIとの連携
3. **管理機能層**: CRUD操作のロジック
4. **静的サイト生成層**: HTMLファイルの生成
5. **UI層**: 管理画面と公開ページ

## アーキテクチャ

```
┌─────────────────────────────────────────────────────┐
│           CLIインターフェース（Python）               │
│  ┌──────────────────────────────────────────────┐   │
│  │ add-book │ list-books │ add-impression       │   │
│  │ update-book │ delete-book │ generate-site   │   │
│  └──────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│         ビジネスロジック層（Python）                  │
│  ┌──────────────────────────────────────────────┐   │
│  │ 本管理 │ 感想管理 │ OpenBD統合 │ HTML生成    │   │
│  └──────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│         データ永続化層（JSON/ファイルシステム）        │
│  ┌──────────────────────────────────────────────┐   │
│  │ books.json │ impressions.json                │   │
│  └──────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│         外部API                                      │
│  ┌──────────────────────────────────────────────┐   │
│  │ OpenBD API (https://openbd.jp/)              │   │
│  └──────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
```

## コンポーネントとインターフェース

### 1. データモデル

#### Book（本）
```python
class Book:
    id: str                    # UUID
    isbn: str                  # ISBN（一意キー）
    title: str                 # タイトル
    author: str                # 著者
    publisher: str             # 出版社
    publication_date: str      # 出版日（YYYY-MM-DD形式）
    description: str           # 説明
    created_at: str            # 登録日時（ISO 8601形式）
    updated_at: str            # 更新日時（ISO 8601形式）
```

#### Impression（感想）
```python
class Impression:
    id: str                    # UUID
    book_id: str               # 本のID（外部キー）
    content: str               # 感想テキスト
    created_at: str            # 投稿日時（ISO 8601形式）
    updated_at: str            # 更新日時（ISO 8601形式）
```

### 2. OpenBD API統合

**インターフェース**: `OpenBDClient`
- `fetch_book_info(isbn: str) -> dict`: ISBNから書誌情報を取得
- エラーハンドリング: ISBNが見つからない場合は例外を発生

### 3. 本管理サービス

**インターフェース**: `BookService`
- `create_book(isbn: str) -> Book`: 本を登録（OpenBD APIから情報取得）
- `get_book(book_id: str) -> Book`: 本を取得
- `list_books() -> List[Book]`: すべての本を取得
- `update_book(book_id: str, **kwargs) -> Book`: 本を更新
- `delete_book(book_id: str) -> None`: 本を削除（関連する感想も削除）

### 4. 感想管理サービス

**インターフェース**: `ImpressionService`
- `create_impression(book_id: str, content: str) -> Impression`: 感想を投稿
- `get_impression(impression_id: str) -> Impression`: 感想を取得
- `list_impressions_by_book(book_id: str) -> List[Impression]`: 本の感想をすべて取得
- `update_impression(impression_id: str, content: str) -> Impression`: 感想を更新
- `delete_impression(impression_id: str) -> None`: 感想を削除
- `delete_impressions_by_book(book_id: str) -> None`: 本の感想をすべて削除

### 5. CLIインターフェース

**インターフェース**: `CLI`
- `add-book <isbn>`: ISBNから本を登録
- `list-books`: 登録されている本を一覧表示
- `show-book <book_id>`: 本の詳細と感想を表示
- `update-book <book_id> [--title] [--author] ...`: 本の情報を更新
- `delete-book <book_id>`: 本を削除
- `add-impression <book_id> <content>`: 感想を投稿
- `update-impression <impression_id> <content>`: 感想を更新
- `delete-impression <impression_id>`: 感想を削除
- `generate-site`: 静的HTMLサイトを生成

### 6. 静的サイト生成

**インターフェース**: `StaticSiteGenerator`
- `generate() -> None`: HTMLサイトを生成
- 出力先: `output/` ディレクトリ
- 生成ファイル:
  - `index.html`: 本の一覧ページ
  - `books/{book_id}.html`: 各本の詳細ページ
  - `style.css`: 最小限のスタイルシート

## データモデル

### ストレージ構造

```
data/
├── books.json          # 本のデータ（JSON配列）
└── impressions.json    # 感想のデータ（JSON配列）
```

### books.json の例
```json
[
  {
    "id": "uuid-1",
    "isbn": "978-4-06-520808-7",
    "title": "ノルウェイの森",
    "author": "村上春樹",
    "publisher": "新潮社",
    "publication_date": "1987-09-04",
    "description": "...",
    "created_at": "2024-01-15T10:30:00Z",
    "updated_at": "2024-01-15T10:30:00Z"
  }
]
```

### impressions.json の例
```json
[
  {
    "id": "uuid-2",
    "book_id": "uuid-1",
    "content": "素晴らしい作品。深い思考を促される。",
    "created_at": "2024-01-16T14:20:00Z",
    "updated_at": "2024-01-16T14:20:00Z"
  }
]
```

## エラーハンドリング

1. **ISBNが見つからない**: OpenBD APIから情報が取得できない場合、ユーザーフレンドリーなエラーメッセージを表示
2. **データファイルの破損**: JSONパースエラーが発生した場合、エラーログを出力し、アプリケーションを安全に終了
3. **ネットワークエラー**: OpenBD APIへのリクエストがタイムアウトした場合、リトライロジックを実装
4. **入力検証**: 空の感想、無効なISBNなどの入力を検証し、エラーメッセージを表示

## 正確性プロパティ

プロパティは、システムが常に満たすべき特性です。これらは、人間が読める仕様と機械検証可能な正確性保証の橋渡しとなります。

### プロパティ1: 本の登録と取得の一貫性
*任意の* ISBNと書誌情報に対して、本を登録してから取得すると、登録時の情報がすべて保持されている。
**検証: 要件1.2**

### プロパティ2: 本の一覧にすべての本が含まれる
*任意の* 本のセットに対して、本一覧を取得すると、登録されているすべての本が含まれている。
**検証: 要件2.1**

### プロパティ3: 本の詳細ページに必須情報が含まれる
*任意の* 本に対して、詳細ページを表示すると、タイトル、著者、出版社、出版日、ISBN、登録日がすべて表示される。
**検証: 要件2.3**

### プロパティ4: 本の更新が反映される
*任意の* 本と新しい情報に対して、本を更新してから取得すると、新しい情報が反映されている。
**検証: 要件3.2**

### プロパティ5: 本の削除時に関連する感想も削除される
*任意の* 本と関連する感想に対して、本を削除すると、その本に紐づくすべての感想も削除される。
**検証: 要件3.4**

### プロパティ6: 感想の投稿と取得の一貫性
*任意の* 本と感想テキストに対して、感想を投稿してから取得すると、投稿時のテキストが保持されている。
**検証: 要件4.1**

### プロパティ7: 感想に投稿日時が記録される
*任意の* 感想に対して、投稿されると、投稿日時が自動的に記録される。
**検証: 要件4.2**

### プロパティ8: 感想の更新が反映される
*任意の* 感想と新しいテキストに対して、感想を更新してから取得すると、新しいテキストが反映されている。
**検証: 要件4.4**

### プロパティ9: 感想の削除が反映される
*任意の* 感想に対して、削除されると、その感想は取得できなくなる。
**検証: 要件4.5**

### プロパティ10: 静的サイト生成ですべての本がHTMLに含まれる
*任意の* 本のセットに対して、静的サイトを生成すると、すべての本がHTMLファイルに含まれている。
**検証: 要件5.1**

### プロパティ11: 生成されたHTMLに本の詳細情報が含まれる
*任意の* 本と感想に対して、詳細ページのHTMLを生成すると、書誌情報と関連するすべての感想が含まれている。
**検証: 要件5.3**

### プロパティ12: データの永続化と復元の一貫性
*任意の* 本と感想に対して、データを保存してから再読み込みすると、同じ状態が復元される。これはラウンドトリッププロパティ。
**検証: 要件6.2**

## テスト戦略

### ユニットテスト

- **データモデルのテスト**: Book、Impressionクラスの生成と検証
- **OpenBD API統合のテスト**: APIレスポンスのパースと例外処理
- **本管理サービスのテスト**: CRUD操作の正確性
- **感想管理サービスのテスト**: CRUD操作の正確性
- **静的サイト生成のテスト**: HTMLファイルの生成確認

### プロパティベーステスト

プロパティベーステスト（PBT）は、ランダムに生成されたデータに対して、システムが常に満たすべき性質を検証します。

**実装要件**:
- プロパティベーステストライブラリ: `hypothesis` (Python)
- 最小実行回数: 100回
- 各テストは対応するプロパティを明示的に参照するコメントを含む
- テストタグ形式: `**Feature: book-library, Property {number}: {property_text}**`
- 各プロパティは1つのプロパティベーステストで実装される

