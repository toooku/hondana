# 蔵書管理アプリケーション v2 - デザイン文書

## 概要

蔵書管理アプリケーションv2は、v1の機能を拡張し、以下の新機能を追加します：

1. **バーコード読み取り**: Webカメラを使用したISBN自動認識
2. **読書ステータス管理**: 積読、読書中、読了の状態管理と履歴追跡
3. **書影表示**: OpenBD APIから取得した本の表紙画像の表示
4. **Markdownベースの感想管理**: 本ごとに1つのMarkdownファイルで感想を管理
5. **Webインターフェース**: Flask/FastAPIを使用したWebUI

## アーキテクチャ

```
┌─────────────────────────────────────────────────────┐
│           ユーザーインターフェース層                  │
│  ┌──────────────────────────────────────────────┐   │
│  │ CLIインターフェース │ Webインターフェース      │   │
│  │ (バーコード読み取り、ステータス管理)          │   │
│  └──────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│         ビジネスロジック層（Python）                  │
│  ┌──────────────────────────────────────────────┐   │
│  │ 本管理 │ ステータス管理 │ 感想管理 │ HTML生成 │   │
│  └──────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│         データ永続化層（JSON/Markdown）               │
│  ┌──────────────────────────────────────────────┐   │
│  │ books.json │ status_history.json             │   │
│  │ impressions/ (Markdownファイル)              │   │
│  └──────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│         外部API                                      │
│  ┌──────────────────────────────────────────────┐   │
│  │ OpenBD API (書誌情報と書影URL)               │   │
│  └──────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
```

## コンポーネントとインターフェース

### 1. 拡張データモデル

#### Book（本）- 拡張版
```python
class Book:
    id: str                    # UUID
    isbn: str                  # ISBN
    title: str                 # タイトル
    author: str                # 著者
    publisher: str             # 出版社
    publication_date: str      # 出版日
    description: str           # 説明
    cover_url: str             # 書影URL（OpenBD APIから取得）
    status: str                # 読書ステータス（積読/読書中/読了）
    created_at: str            # 登録日時
    updated_at: str            # 更新日時
```

#### StatusHistory（ステータス履歴）- 新規
```python
class StatusHistory:
    id: str                    # UUID
    book_id: str               # 本のID
    old_status: str            # 変更前のステータス
    new_status: str            # 変更後のステータス
    changed_at: str            # 変更日時
```

#### Impression（感想）- 簡略版
```python
class Impression:
    id: str                    # UUID
    book_id: str               # 本のID
    file_path: str             # Markdownファイルのパス
    created_at: str            # 作成日時
    updated_at: str            # 更新日時
```

### 2. バーコード読み取り機能

**インターフェース**: `BarcodeScanner`
- `start_camera()`: Webカメラを起動
- `scan_barcode() -> str`: ISBNバーコードを読み取り
- `stop_camera()`: カメラを停止

**実装ライブラリ**: `pyzbar`, `opencv-python`

### 3. ステータス管理サービス

**インターフェース**: `StatusService`
- `set_status(book_id: str, status: str) -> Book`: ステータスを変更
- `get_status(book_id: str) -> str`: 現在のステータスを取得
- `get_status_history(book_id: str) -> List[StatusHistory]`: ステータス履歴を取得
- `get_books_by_status(status: str) -> List[Book]`: ステータスごとに本を取得

### 4. 感想管理サービス（拡張版）

**インターフェース**: `ImpressionService` (v2)
- `create_impression(book_id: str, content: str) -> Impression`: Markdownファイルを作成
- `get_impression(book_id: str) -> str`: Markdownファイルから感想を読み込み
- `update_impression(book_id: str, content: str) -> Impression`: Markdownファイルを更新
- `delete_impression(book_id: str) -> None`: Markdownファイルを削除

### 5. Webインターフェース

**フレームワーク**: Flask または FastAPI
- `/`: ホームページ
- `/scan`: バーコード読み取り画面
- `/books`: 本一覧（ステータスフィルタ付き）
- `/books/<id>`: 本詳細（書影、ステータス、感想表示）
- `/books/<id>/status`: ステータス変更API
- `/books/<id>/impression`: 感想編集画面

### 6. 静的サイト生成（拡張版）

**インターフェース**: `StaticSiteGenerator` (v2)
- `generate() -> None`: HTMLサイトを生成
- 出力ファイル:
  - `index.html`: ステータスごとの本分類表示
  - `books/{book_id}.html`: 本詳細（書影、ステータス、Markdown感想をHTML変換）
  - `style.css`: スタイルシート

## データモデル

### ストレージ構造

```
data/
├── books.json                  # 本のデータ（拡張版）
├── status_history.json         # ステータス履歴
└── impressions/
    ├── {book_id}.md           # 本ごとの感想ファイル
    └── ...
```

### books.json の例（v2）
```json
[
  {
    "id": "uuid-1",
    "isbn": "978-4-06-520808-7",
    "title": "ノルウェイの森",
    "author": "村上春樹",
    "publisher": "新潮社",
    "publication_date": "1987-09-04",
    "description": "...",
    "cover_url": "https://cover.openbd.jp/...",
    "status": "読了",
    "created_at": "2024-01-15T10:30:00Z",
    "updated_at": "2024-01-20T15:45:00Z"
  }
]
```

### status_history.json の例
```json
[
  {
    "id": "uuid-2",
    "book_id": "uuid-1",
    "old_status": "積読",
    "new_status": "読書中",
    "changed_at": "2024-01-16T10:00:00Z"
  },
  {
    "id": "uuid-3",
    "book_id": "uuid-1",
    "old_status": "読書中",
    "new_status": "読了",
    "changed_at": "2024-01-20T15:45:00Z"
  }
]
```

### impressions/{book_id}.md の例
```markdown
# ノルウェイの森 - 感想

## 全体的な印象
素晴らしい作品。深い思考を促される。

## 好きなシーン
- 主人公とナオコの会話シーン
- 森での瞑想シーン

## 感想
この作品は...
```

## エラーハンドリング

1. **バーコード読み取り失敗**: カメラアクセス拒否、バーコード認識失敗
2. **書影URL取得失敗**: デフォルト画像を使用
3. **Markdownファイル操作エラー**: ファイル読み書きエラーの処理
4. **データ移行エラー**: v1からv2への移行時のエラー処理

## 正確性プロパティ

プロパティは、システムが常に満たすべき特性です。これらは、人間が読める仕様と機械検証可能な正確性保証の橋渡しとなります。

### プロパティ1: 新規本のデフォルトステータス
*任意の* ISBNと書誌情報に対して、本を登録すると、ステータスは「積読」に設定される。
**検証: 要件2.1**

### プロパティ2: ステータス変更の永続化
*任意の* 本と新しいステータスに対して、ステータスを変更してから取得すると、新しいステータスが返される。
**検証: 要件2.2**

### プロパティ3: ステータス変更履歴の記録
*任意の* 本とステータス変更に対して、ステータスを変更すると、変更履歴に記録される。
**検証: 要件2.3**

### プロパティ4: ステータスごとの本の分類
*任意の* ステータスに対して、そのステータスの本を取得すると、すべての該当する本が返される。
**検証: 要件2.4**

### プロパティ5: 書影URLの取得と保存
*任意の* ISBNに対して、本を登録すると、書影URLが保存される（取得できない場合はデフォルト値）。
**検証: 要件3.1, 3.2**

### プロパティ6: 生成されたHTMLに書影が含まれる
*任意の* 本と書影URLに対して、静的サイトを生成すると、詳細ページに書影が表示される。
**検証: 要件3.3**

### プロパティ7: 本一覧ページに書影が含まれる
*任意の* 本のセットに対して、静的サイトを生成すると、本一覧ページのすべての本に書影が表示される。
**検証: 要件3.4**

### プロパティ8: 感想ファイルのラウンドトリップ
*任意の* 本と感想テキストに対して、感想を作成してから読み込むと、同じテキストが返される。
**検証: 要件4.1, 4.2**

### プロパティ9: 感想ファイルの更新
*任意の* 感想ファイルと新しいテキストに対して、感想を更新してから読み込むと、新しいテキストが返される。
**検証: 要件4.3**

### プロパティ10: Markdownから HTMLへの変換
*任意の* Markdownテキストに対して、HTMLに変換すると、元のテキストの構造が保持される。
**検証: 要件4.4**

### プロパティ11: 生成されたサイトにすべての機能が含まれる
*任意の* 本のセット、ステータス、感想に対して、静的サイトを生成すると、ステータスごとの分類、書影、Markdown形式の感想がすべて表示される。
**検証: 要件5.2**

### プロパティ12: v1データの互換性
*任意の* v1のデータに対して、v2で読み込むと、既存のデータが正しく解析され、新しいフィールドにデフォルト値が設定される。
**検証: 要件6.1**

### プロパティ13: 感想ファイルへの移行
*任意の* v1の感想データに対して、v2に移行すると、対応するMarkdownファイルが作成される。
**検証: 要件6.2**

### プロパティ14: 移行後のデータ互換性
*任意の* 移行されたデータに対して、v2で保存してから読み込むと、データが正しく保持される。
**検証: 要件6.3**

## テスト戦略

### ユニットテスト

- **ステータス管理のテスト**: ステータス変更と履歴記録
- **感想ファイル操作のテスト**: Markdownファイルの作成、読み込み、更新
- **書影URL取得のテスト**: OpenBD APIからの書影URL取得
- **データ移行のテスト**: v1からv2への移行

### プロパティベーステスト

- **ステータス変更の記録**: すべてのステータス変更が記録される
- **ステータスごとの分類**: 正しい本が返される
- **感想ファイルのラウンドトリップ**: 作成→読み込みで同じテキストが返される
- **Markdown変換**: 構造が保持される
- **データ移行**: 既存データが正しく変換される

